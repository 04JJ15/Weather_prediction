## 1. 프로젝트 개요
- **과제명:** 기상 예측 지점–관측 지점 오차 보정 회귀모델 개발  
- **목표:** 예측값으로 실제 관측값(습도·기온·대기압) 보정 → MAE/RMSE 최소화  
- **평가 지표:** 가중치(습도 0.3 · 기온 0.5 · 대기압 0.2) 적용한 RMSE/MAE  

## 2. 프로젝트 구조
```plaintext
weather_prediction_project/
├── data/                   # 원본·병합 CSV
├── models/                 # 학습된 모델(.pkl)
├── src/
│   ├── preprocessing.py    # load_and_merge() + 단위 통일
│   ├── train.py            # LightGBM 학습 및 저장
│   └── evaluate.py         # 모델 평가 및 가중 점수 계산
└── main.py                 # EDA (병합 확인·통계·이상치·상관관계)
```

## 3. 수행 계획
1. **환경 구성** (VSCode, 필수 라이브러리 설치)  
2. **데이터 준비** (`data/`에 예측·관측 CSV 배치)  
3. **전처리** (`src/preprocessing.py`): 시간 병합 + 대기압 단위 통일  
4. **병합 확인 & CSV 저장** (`main.py`)  
5. **EDA: 결측치·기초 통계·이상치 점검** (`main.py`)  
6. **변수별 통계 해석** (`main.py`)  
7. **Feature/Target 분리** (`main.py`)  
8. **상관관계 히트맵 시각화** (`main.py`)  
9. **베이스라인 모델 학습** (`src/train.py`): LightGBM 학습 & 저장  
10. **모델 평가 & 가중 점수 계산** (`src/evaluate.py`)

## 4. 주요 EDA 결과
- **결측치:** 없음  
- **기초 통계:**  
  - **일사량:** 절반 이상 0 → 시간·계절 변수 필요  
  - **절대습도:** 분산 작음 → 기여도 검토  
  - **기온:** 음수 포함(동절기) → 계절별 보정 필요  
  - **대기압:** 단위 통일(hPa→mmHg) 완료  
- **이상치:** 물리적 타당 → 유지

## 5. 피처 & 타겟
```python
features = [
    '일사량(w/m^2)_예측',
    '습도(%)_예측',
    '절대습도_예측',
    '기온(degC)_예측',
    '대기압(mmHg)_예측'
]
targets = [
    '습도(%)_관측',
    '기온(degC)_관측',
    '대기압(mmHg)_관측'
]
```

## 6. 10단계 평가 결과
| Target               | MAE    | RMSE   | 가중 점수 |
|----------------------|--------|--------|-----------|
| 습도(%)_관측         | 5.9097 | 7.7887 | 2.0548    |
| 기온(degC)_관측      | 0.9673 | 1.2514 | 0.5547    |
| 대기압(mmHg)_관측    | 0.3666 | 0.4777 | 0.0844    |
| **최종 스코어**      |        |        | **2.6939** |

## 7. 11단계 결과 비교: 시간 파생 변수 도입 전·후

아래 표는 **10단계(시간 파생 변수 도입 전)**와 **11단계(도입 후)**의 MAE·RMSE 및 가중 점수를 나란히 비교한 것입니다.

| Target               | 단계 | MAE    | RMSE   | (MAE+RMSE)/2 | 가중치 | 가중 점수 |
|----------------------|------|--------|--------|--------------|--------|-----------|
| **습도(%)_관측**     | 10   | 5.9097 | 7.7887 | 6.8492       | 0.3    | 2.0548    |
|                      | 11   | 4.7764 | 6.3366 | 5.5565       | 0.3    | 1.6669    |
| **기온(degC)_관측**  | 10   | 0.9673 | 1.2514 | 1.1094       | 0.5    | 0.5547    |
|                      | 11   | 0.8152 | 1.0564 | 0.9358       | 0.5    | 0.4679    |
| **대기압(mmHg)_관측**| 10   | 0.3666 | 0.4777 | 0.4222       | 0.2    | 0.0844    |
|                      | 11   | 0.3055 | 0.4007 | 0.3531       | 0.2    | 0.0706    |
| **최종 스코어**      | 10   | —      | —      | —            | —      | **2.6939**|
|                      | 11   | —      | —      | —            | —      | **2.2055**|

### 1. 습도(%)_관측
- **MAE:** 5.9097 → 4.7764 (↓1.1333)  
- **RMSE:** 7.7887 → 6.3366 (↓1.4521)  
- **가중 점수:** 2.0548 → 1.6669 (↓0.3879)

💡 시간 파생 변수를 통해 “특정 시간대에 습도가 어떻게 변화하는가” 정보를 모델이 학습할 수 있어,  
절반 이상이 0인 일사량과 함께 시간대 신호가 습도 보정에 유의미하게 기여했습니다.

---

### 2. 기온(degC)_관측
- **MAE:** 0.9673 → 0.8152 (↓0.1521)  
- **RMSE:** 1.2514 → 1.0564 (↓0.1950)  
- **가중 점수:** 0.5547 → 0.4679 (↓0.0868)

💡 하루 중 기온 변화 패턴(아침 vs 한낮 vs 저녁) 정보를 추가함으로써,  
특히 낮과 밤의 온도 차이를 더 정확하게 보정할 수 있었습니다.

---

### 3. 대기압(mmHg)_관측
- **MAE:** 0.3666 → 0.3055 (↓0.0611)  
- **RMSE:** 0.4777 → 0.4007 (↓0.0770)  
- **가중 점수:** 0.0844 → 0.0706 (↓0.0138)

💡 대기압도 시간대별 변동이 존재하므로, 단위 통일 후 시간 정보를 반영하면 오차가 줄어듭니다.

---

### 4. 최종 가중 평균 점수
- **도입 전:** 2.6939  
- **도입 후:** 2.2055 (↓0.4884)  

> **결론:**  
> 시간 파생 변수를 추가하여 모든 타깃에서 MAE와 RMSE가 감소했고,  
> 공모전의 가중 평균 점수도 약 0.49 포인트 개선되었습니다.  
> 이는 기상 데이터의 “시간·계절 패턴”을 반영했을 때 오차 보정 효과가 상당함을 의미합니다.


## 11단계 이어서 진행 계획

### 앞서 완료한 1단계
- **시간 파생 변수 추가**  
  `src/preprocessing.py` 에서 `hour`, `month`, `weekday` 피처를 생성하고  
  이를 기반으로 모델을 재학습·재평가하여 성능(가중 평균 점수)이 2.6939 → 2.2055로 개선됨.

---

## 2단계: 교호작용(Interaction) 피처 생성

1. **왜 하는가?**  
   - 두 개 이상의 변수가 함께 작용할 때 생기는 효과(예: “일사량과 기온이 동시에 높으면 실제 관측 기온이 더 크게 오차” 같은 패턴)를 잡아내기 위해  
   - 단일 피처만 넣을 때보다, 변수 곱(또는 비율 등)으로 새로운 차원을 모델에 제공하면 예측력이 올라갈 수 있음.

2. **어떤 피처를 만들까?**  
   ```python
   # 예시 가능한 교호작용
   merged['일사량×기온']      = merged['일사량(w/m^2)_예측'] * merged['기온(degC)_예측']
   merged['습도×기온']       = merged['습도(%)_예측'] * merged['기온(degC)_예측']
   merged['일사량×절대습도']  = merged['일사량(w/m^2)_예측'] * merged['절대습도_예측']
   # 필요에 따라 추가
  ```
## 11-2 단계 결과 비교: 상호작용 피처 도입 전·후

아래 표는 **10단계(기본 피처만)**, **11-1단계(시간 파생 변수 추가)**, **11-2단계(시간 파생 + 상호작용 피처)**의 MAE·RMSE 및 가중 점수를 나란히 비교한 것입니다.

| Target               | 단계   | MAE    | RMSE   | (MAE+RMSE)/2 | 가중치 | 가중 점수 |
|----------------------|--------|--------|--------|--------------|--------|-----------|
| **습도(%)_관측**     | 10     | 5.9097 | 7.7887 | 6.8492       | 0.3    | 2.0548    |
|                      | 11-1   | 4.7764 | 6.3366 | 5.5565       | 0.3    | 1.6669    |
|                      | 11-2   | 4.7195 | 6.2527 | 5.4861       | 0.3    | 1.6458    |
| **기온(degC)_관측**  | 10     | 0.9673 | 1.2514 | 1.1094       | 0.5    | 0.5547    |
|                      | 11-1   | 0.8152 | 1.0564 | 0.9358       | 0.5    | 0.4679    |
|                      | 11-2   | 0.8111 | 1.0495 | 0.9303       | 0.5    | 0.4652    |
| **대기압(mmHg)_관측**| 10     | 0.3666 | 0.4777 | 0.4222       | 0.2    | 0.0844    |
|                      | 11-1   | 0.3055 | 0.4007 | 0.3531       | 0.2    | 0.0706    |
|                      | 11-2   | 0.3025 | 0.3974 | 0.3499       | 0.2    | 0.0700    |
| **최종 스코어**      | 10     |        |        |              |        | **2.6939**|
|                      | 11-1   |        |        |              |        | **2.2055**|
|                      | 11-2   |        |        |              |        | **2.1810**|

---

### 1. 습도(%)_관측
- **10단계:** MAE 5.9097 → **11-1:** MAE 4.7764 (↓1.1333) → **11-2:** MAE 4.7195 (↓0.0569)  
- **10단계:** RMSE 7.7887 → **11-1:** RMSE 6.3366 (↓1.4521) → **11-2:** RMSE 6.2527 (↓0.0839)  
- 가중 점수: 2.0548 → **11-1:** 1.6669 (↓0.3879) → **11-2:** 1.6458 (↓0.0211)  

> 상호작용 피처(일사량×기온 등)를 추가하자, 습도 오차가 소폭 더 감소했습니다.  
> “일사량과 기온이 동시에 높을 때의 습도 패턴” 같은 비선형 정보를 일부 캡처한 효과로 보입니다.

---

### 2. 기온(degC)_관측
- **10단계:** MAE 0.9673 → **11-1:** 0.8152 (↓0.1521) → **11-2:** 0.8111 (↓0.0041)  
- **10단계:** RMSE 1.2514 → **11-1:** 1.0564 (↓0.1950) → **11-2:** 1.0495 (↓0.0069)  
- 가중 점수: 0.5547 → **11-1:** 0.4679 (↓0.0868) → **11-2:** 0.4652 (↓0.0027)  

> 기온에 대해서도 상호작용 피처는 추가적인 미세 개선을 제공했습니다.  
> 주로 “습도×기온” 조합이 낮과 밤의 복합 영향 등을 보정했을 것으로 추정됩니다.

---

### 3. 대기압(mmHg)_관측
- **10단계:** MAE 0.3666 → **11-1:** 0.3055 (↓0.0611) → **11-2:** 0.3025 (↓0.0030)  
- **10단계:** RMSE 0.4777 → **11-1:** 0.4007 (↓0.0770) → **11-2:** 0.3974 (↓0.0033)  
- 가중 점수: 0.0844 → **11-1:** 0.0706 (↓0.0138) → **11-2:** 0.0700 (↓0.0006)  

> 대기압에서도 상호작용 피처의 효과는 소폭이나마 확인됩니다.  
> 시간 파생 변수 도입으로 이미 많이 개선된 상태에서, 교호작용이 조금 더 미세 조정을 해준 모습입니다.

---

### 4. 최종 가중 평균 점수
- **10단계:** 2.6939  
- **11-1:** 2.2055 (↓0.4884)  
- **11-2:** 2.1810 (↓0.0245)  

> **요약:**  
> 1) 시간 파생 변수를 추가한 후(11-1) 모델 성능이 크게 개선되었고,  
> 2) 상호작용 피처를 추가한 후(11-2)에도 **소폭 추가 개선**이 이루어졌습니다.  
> 즉, 교호작용 피처는 이미 반영된 시간·계절 정보를 보완하는 역할로, 특히 습도와 기온 오차를 더 줄여주었습니다.

---

## 결론
- **주요 성능 향상 요인:**  
  1. **시간 파생 변수** 추가(하루·계절 패턴 캡처)  
  2. **교호작용 피처** 추가(변수 간 상호 영향 보정)  

- **다음 단계:**  
  1. 하이퍼파라미터 튜닝 → 추가 성능 개선 여부 확인  
  2. 교차검증 도입 → 일반화 성능 점검  
  3. 모델 앙상블 → 최종 성능 안정화 및 향상

## 11-3 하이퍼파라미터 튜닝

### 왜 하는가?
- 기본 LightGBM 기본 설정(파라미터 기본값)만으로는 **각 타깃마다 최적의 성능을 내기 어렵습니다**.  
- `num_leaves`, `learning_rate`, `n_estimators`, `max_depth` 등 주요 파라미터를 조정하면  
  - 모델이 데이터의 복잡한 패턴을 더 잘 학습하고  
  - **MAE/RMSE를 추가로 낮출 수 있습니다**.  
- 또한, 단일 학습이 아닌 **교차검증**과 결합하면 과적합 위험을 줄이며, 일반화 성능을 더 객관적으로 평가할 수 있습니다.

---

### 어떻게 진행할까?
1. **GridSearchCV + TimeSeriesSplit** 사용  
   - `TimeSeriesSplit`을 이용해 시계열 순서를 유지하며 훈련/검증 분할  
   - `GridSearchCV`로 미리 정의한 파라미터 그리드를 순차적으로 탐색  
   - 평가는 RMSE(`neg_root_mean_squared_error`) 기준  

2. **train.py 수정 방법**  
   - 기존 `LGBMRegressor.fit(X, y[col])` 부분을 `GridSearchCV`로 교체  
   - 최적의 파라미터가 발견된 모델을 `models/` 폴더에 저장  
   - 탐색 범위 예시:  
     ```python
     param_grid = {
       'num_leaves': [31, 63],
       'learning_rate': [0.1, 0.01],
       'n_estimators': [100, 300],
       'max_depth': [ -1, 10, 20 ]
     }
     ```
